<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxa Record Slide v4</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* ============================================================
           DESIGN SYSTEM
           ============================================================ */
        :root {
            /* Colors - Natural Stone Scale */
            --gray-50: #fafaf8;
            --gray-75: #f8f8f6;
            --gray-100: #f6f5f3;
            --gray-200: #e7e5e4;
            --gray-300: #d6d3d1;
            --gray-400: #a8a29e;
            --gray-500: #78716c;
            --gray-600: #57534e;
            --gray-700: #44403c;
            --gray-800: #292524;
            --gray-900: #1c1917;
            
            /* Colors - Accent */
            --accent: #4a6fa5;
            --accent-light: #eef2f7;
            --accent-dark: #3a5a8a;
            
            /* Colors - Semantic */
            --success: #6b8f71;
            --warning: #c9a227;
            --error: #b54848;
            
            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 24px;
            --space-6: 32px;
            --space-8: 48px;
            
            /* Typography */
            --font-family: system-ui, -apple-system, sans-serif;
            --font-mono: 'SF Mono', Monaco, Consolas, monospace;
            --text-xs: 0.675rem;
            --text-sm: 0.8rem;
            --text-base: 0.9rem;
            --text-lg: 1.1rem;
            --text-xl: 1.35rem;
            --leading-tight: 1.25;
            --leading-normal: 1.5;
            
            /* Borders & Radius */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 10px;
            --border: 1px solid var(--gray-200);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            
            /* Transitions */
            --transition-fast: 0.1s ease;
            --transition-base: 0.2s ease;
        }
        
        /* ============================================================
           RESET & BASE
           ============================================================ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            font-size: var(--text-base);
            line-height: var(--leading-normal);
            color: var(--gray-800);
            background: var(--gray-100);
            min-height: 100vh;
            padding: var(--space-6);
        }
        
        /* ============================================================
           BUTTONS
           ============================================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            font-family: inherit;
            font-size: var(--text-sm);
            font-weight: 500;
            line-height: 1;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: var(--border);
            background: white;
            color: var(--gray-700);
        }
        .btn:hover { background: var(--gray-50); border-color: var(--gray-300); }
        .btn:active { background: var(--gray-100); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn--primary { background: var(--gray-800); border-color: var(--gray-800); color: white; }
        .btn--primary:hover { background: var(--gray-700); border-color: var(--gray-700); }
        .btn--sm { padding: var(--space-1) var(--space-2); font-size: var(--text-xs); }
        
        .btn-ai, .btn-add {
            padding: 0 var(--space-1);
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--gray-400);
            background: transparent;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .btn-ai:hover, .btn-add:hover { color: var(--gray-600); border-color: var(--gray-400); }
        .btn-ai { margin-left: var(--space-1); vertical-align: middle; }
        .btn-add { margin-left: auto; width: 16px; height: 16px; font-weight: 400; line-height: 1; }
        
        /* ============================================================
           INPUTS
           ============================================================ */
        .input, .textarea, .select {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            font-family: inherit;
            font-size: var(--text-sm);
            line-height: var(--leading-normal);
            color: var(--gray-800);
            background: white;
            border: 1px solid var(--gray-100);
            border-radius: var(--radius-sm);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }
        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        .textarea { min-height: 80px; resize: vertical; }
        .textarea--auto { resize: none; overflow-y: hidden; }
        .select { cursor: pointer; }
        
        .input--inline { padding: var(--space-1) var(--space-2); background: transparent; border-color: transparent; }
        .input--inline:hover { background: var(--gray-50); }
        .input--inline:focus { background: white; border-color: var(--accent); }
        .input--muted { color: var(--gray-500); font-size: var(--text-sm); }
        .input--muted::placeholder { color: var(--gray-300); }
        
        .input.input--underline {
            padding: var(--space-2) 0;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--gray-300);
            border-radius: 0;
        }
        .input.input--underline:focus { border-color: transparent; border-bottom-color: var(--accent); box-shadow: none; }
        .input.input--underline::placeholder { color: var(--gray-400); }
        
        /* ============================================================
           CARDS
           ============================================================ */
        .card {
            background: white;
            border: var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        .card__header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-bottom: var(--border);
            background: var(--gray-50);
        }
        .card__title { font-size: var(--text-sm); font-weight: 600; color: var(--gray-700); }
        .card__actions { margin-left: auto; display: flex; gap: var(--space-2); }
        .card__body { padding: var(--space-4); }
        
        /* ============================================================
           BADGES & TABS
           ============================================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            font-weight: 500;
            line-height: 1;
            color: var(--gray-600);
            background: var(--gray-200);
            border-radius: var(--radius-sm);
        }
        
        .tabs { display: flex; gap: 2px; padding: 2px; background: var(--gray-200); border-radius: var(--radius-sm); }
        .tab {
            padding: var(--space-1) var(--space-3);
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--gray-600);
            background: transparent;
            border: none;
            border-radius: calc(var(--radius-sm) - 2px);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .tab:hover { color: var(--gray-800); }
        .tab.active { color: var(--gray-800); background: white; box-shadow: var(--shadow-sm); }
        .tab__count { margin-left: var(--space-1); padding: 0 var(--space-1); font-size: 0.6rem; background: var(--gray-300); border-radius: 2px; }
        .tab.active .tab__count { background: var(--gray-200); }
        
        /* ============================================================
           DROPDOWN
           ============================================================ */
        .dropdown { position: relative; }
        .dropdown__menu {
            display: none;
            position: absolute;
            top: calc(100% + var(--space-1));
            right: 0;
            min-width: 180px;
            background: white;
            border: var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            overflow: hidden;
        }
        .dropdown__menu.open { display: block; }
        .dropdown__section { padding: var(--space-2) 0; }
        .dropdown__label { padding: var(--space-1) var(--space-3); font-size: var(--text-xs); font-weight: 500; color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.5px; }
        .dropdown__item {
            display: block;
            width: 100%;
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-sm);
            text-align: left;
            color: var(--gray-700);
            background: none;
            border: none;
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        .dropdown__item:hover { background: var(--gray-50); }
        .dropdown__divider { height: 1px; background: var(--gray-100); margin: var(--space-1) 0; }
        
        /* ============================================================
           MODALS
           ============================================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal { width: 400px; max-width: 90vw; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); overflow: hidden; }
        .modal--large { width: 800px; }
        .modal__header { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-4); border-bottom: var(--border); }
        .modal__title { font-size: var(--text-base); font-weight: 600; }
        .modal__close { margin-left: auto; padding: 0; font-size: 1.5rem; line-height: 1; color: var(--gray-400); background: none; border: none; cursor: pointer; }
        .modal__close:hover { color: var(--gray-600); }
        .modal__body { padding: var(--space-4); }
        .modal__footer { display: flex; justify-content: space-between; padding: var(--space-3) var(--space-4); border-top: var(--border); background: var(--gray-50); }
        
        /* ============================================================
           TOAST
           ============================================================ */
        .toast {
            position: fixed;
            bottom: var(--space-6);
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            padding: var(--space-3) var(--space-4);
            font-size: var(--text-sm);
            color: white;
            background: var(--gray-800);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transition: all var(--transition-base);
            pointer-events: none;
            z-index: 1001;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* ============================================================
           FIELDS
           ============================================================ */
        .field { display: flex; flex-direction: column; gap: var(--space-2); }
        .field__label { display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-xs); font-weight: 500; color: var(--gray-500); }
        .field__actions { margin-left: auto; }
        .field__hint { margin-top: var(--space-1); font-size: var(--text-xs); color: var(--gray-400); font-weight: normal; }
        .field-row { display: flex; gap: var(--space-5); align-items: flex-end; }
        .field--inline { display: flex; flex-direction: column; gap: var(--space-1); }
        .field--inline .field__label { margin-bottom: 0; }
        
        /* ============================================================
           DATA TABLE
           ============================================================ */
        .data-table-wrap { overflow-x: auto; border: var(--border); border-radius: var(--radius-sm); background: white; display: inline-block; }
        .data-table { border-collapse: collapse; font-size: var(--text-xs); font-family: var(--font-family); }
        
        .data-table th {
            padding: var(--space-1) var(--space-2);
            font-weight: 600;
            text-align: left;
            color: var(--gray-700);
            background: var(--gray-50);
            border-bottom: var(--border);
            border-right: var(--border);
            white-space: nowrap;
        }
        .data-table th:first-child { position: sticky; left: 0; z-index: 2; background: var(--gray-50); }
        .data-table th.col-header { text-align: right; font-weight: 500; color: var(--gray-500); }
        .data-table th.total-col { background: var(--gray-100); color: var(--gray-700); text-align: right; }
        
        .data-table td {
            padding: var(--space-1) var(--space-2);
            border-bottom: var(--border);
            border-right: var(--border);
            white-space: nowrap;
            text-align: right;
            color: var(--gray-700);
        }
        .data-table td:first-child { position: sticky; left: 0; z-index: 1; background: white; text-align: left; }
        .data-table td.total-col { font-weight: 600; background: var(--gray-50); border-left: 2px solid var(--gray-200); }
        .data-table tr:last-child td, .data-table tr:last-child th { border-bottom: none; }
        .data-table td:last-child, .data-table th:last-child { border-right: none; }
        .data-table tbody tr:hover td { background: var(--gray-50); }
        .data-table tbody tr:hover td:first-child { background: var(--gray-50); }
        
        .data-table .series-label { display: flex; align-items: center; gap: var(--space-1); font-weight: 600; color: var(--gray-700); }
        .data-table .series-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
        
        .data-table input[type="text"] {
            width: 100%;
            min-width: 60px;
            padding: var(--space-1);
            font-family: var(--font-family);
            font-size: var(--text-xs);
            text-align: right;
            border: none;
            background: transparent;
            color: var(--gray-700);
        }
        .data-table input[type="text"]:focus { outline: none; background: var(--accent-light); }
        .data-table input.series-name-input { text-align: left; font-weight: 600; min-width: 70px; }
        
        .data-table .color-picker { width: 14px; height: 14px; padding: 0; border: none; background: none; cursor: pointer; flex-shrink: 0; }
        .data-table .color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        .data-table .color-picker::-webkit-color-swatch { border: 1px solid var(--gray-300); border-radius: 2px; }
        
        .data-table select { padding: 0; font-family: var(--font-family); font-size: var(--text-xs); border: none; background: transparent; cursor: pointer; color: var(--gray-500); text-align: right; }
        .data-table select:focus { outline: none; }
        .data-table .col-date-select { min-width: 65px; }
        
        .data-table td.value-cell { position: relative; cursor: pointer; }
        .data-table td.value-cell:hover::after { content: '+'; position: absolute; top: 2px; right: 2px; font-size: 9px; color: var(--gray-300); line-height: 1; }
        .data-table td.has-comment { position: relative; cursor: pointer; }
        .data-table td .comment-dot { position: absolute; top: 3px; right: 3px; width: 5px; height: 5px; background: var(--accent); border-radius: 50%; }
        .data-table td.has-comment:hover { background: var(--accent-light); }
        .data-table td.value-cell.has-comment:hover::after { display: none; }
        
        /* ============================================================
           LAYOUT
           ============================================================ */
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin-top: var(--space-8); }
        .section__header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3); }
        .section__title { font-size: var(--text-xs); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--gray-400); }
        
        .toolbar { display: flex; align-items: center; gap: var(--space-3); margin-left: auto; }
        .toolbar__divider { width: 1px; height: 20px; background: var(--gray-200); }
        .toolbar__status { font-size: var(--text-xs); color: var(--gray-400); }
        .toolbar__status--saving { color: var(--warning); }
        .toolbar__status--saved { color: var(--success); }
        
        /* ============================================================
           SLIDE
           ============================================================ */
        .slide {
            aspect-ratio: 16 / 9;
            display: grid;
            grid-template-columns: var(--col-split, 35%) 6px var(--col-split-right, 65%);
            grid-template-rows: var(--row-title, auto) 1fr;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        .slide__zone { padding: var(--space-4); position: relative; }
        .slide__zone::after {
            content: attr(data-zone);
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            padding: var(--space-1) var(--space-2);
            font-size: 0.6rem;
            font-weight: 500;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            border-radius: var(--radius-sm);
            opacity: 0;
            transition: opacity var(--transition-fast);
            pointer-events: none;
        }
        .slide__zone:hover::after { opacity: 1; }
        
        .slide.view-table .slide__title,
        .slide.view-table .slide__description,
        .slide.view-table .resize-handle,
        .slide.view-notes .slide__title,
        .slide.view-notes .slide__description,
        .slide.view-notes .resize-handle { display: none; }
        .slide.view-table .slide__viz,
        .slide.view-notes .slide__viz { grid-column: 1 / -1; grid-row: 1 / -1; }
        
        .slide__title { grid-column: 1 / -1; grid-row: 1; display: flex; align-items: center; padding: var(--space-4) var(--space-5); }
        .slide__title-content { display: flex; flex-direction: column; gap: var(--space-1); }
        .slide__section-header { font-size: var(--text-xs); font-weight: 500; color: var(--gray-400); letter-spacing: 0.3px; }
        .slide__title h1 { font-size: var(--text-xl); font-weight: 600; color: var(--gray-900); }
        
        .slide__description { grid-column: 1; grid-row: 2; display: flex; flex-direction: column; overflow: hidden; }
        .slide__description-content { flex: 1; overflow-y: auto; padding: var(--space-4); position: relative; }
        .slide__description-content.has-overflow { border: 2px solid var(--warning); border-radius: var(--radius-sm); }
        .slide__description-content.has-overflow::after {
            content: 'Content overflow — try smaller size';
            position: absolute;
            bottom: var(--space-2);
            right: var(--space-2);
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            font-weight: 500;
            color: white;
            background: var(--warning);
            border-radius: var(--radius-sm);
        }
        
        .slide__viz { grid-column: 3; grid-row: 2; display: flex; flex-direction: column; overflow: hidden; padding: var(--space-3); }
        .slide__viz-header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-2); }
        .slide__viz-unit { font-size: var(--text-xs); color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.5px; }
        .slide__viz-legend { display: flex; gap: var(--space-3); flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: var(--space-1); font-size: var(--text-xs); color: var(--gray-600); }
        .legend-color { width: 12px; height: 3px; border-radius: 1px; }
        .slide__viz-content { flex: 1; min-height: 0; overflow: hidden; }
        
        .viz-view { display: none; height: 100%; }
        .viz-view.active { display: block; }
        .chart-container { height: 100%; position: relative; }
        
        .resize-handle { background: transparent; z-index: 10; }
        .resize-handle:hover { background: var(--accent-light); }
        .resize-handle--col { cursor: col-resize; grid-row: 2; }
        
        /* ============================================================
           MARKDOWN
           ============================================================ */
        .markdown { color: var(--gray-700); font-size: var(--text-sm); line-height: var(--leading-normal); }
        .markdown h1, .markdown h2, .markdown h3 { margin-top: 0.5em; margin-bottom: 0.25em; font-weight: 600; color: var(--gray-800); }
        .markdown h1 { font-size: 1.1em; }
        .markdown h2 { font-size: 1em; }
        .markdown h3 { font-size: 0.95em; }
        .markdown p { margin-bottom: 0.5em; }
        .markdown ul, .markdown ol { margin-left: 0; margin-bottom: 0.5em; padding-left: 1.25em; }
        .markdown ul { list-style-type: disc; }
        .markdown ol { list-style-type: decimal; }
        .markdown li { margin-bottom: 0.25em; }
        .markdown code { padding: 0.1em 0.3em; font-family: var(--font-mono); font-size: 0.9em; background: var(--gray-100); border-radius: var(--radius-sm); }
        .markdown pre { padding: var(--space-3); font-family: var(--font-mono); font-size: var(--text-xs); background: var(--gray-800); color: var(--gray-100); border-radius: var(--radius-sm); overflow-x: auto; }
        .markdown pre code { padding: 0; background: none; }
        .markdown strong { font-weight: 600; }
        .markdown a { color: var(--accent); text-decoration: underline; }
        
        /* ============================================================
           VIZ CONTAINERS
           ============================================================ */
        .viz-table-container { height: 100%; overflow: auto; }
        .viz-table-container .data-table-wrap { border: none; border-radius: 0; display: block; }
        
        .viz-notes-container { height: 100%; overflow-y: auto; padding: var(--space-2); }
        .viz-notes-empty { padding: var(--space-4); text-align: center; color: var(--gray-400); font-size: var(--text-sm); }
        .viz-note-item { padding: var(--space-2) var(--space-3); border-bottom: 1px solid var(--gray-100); }
        .viz-note-item:last-child { border-bottom: none; }
        .viz-note-item__header { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1); }
        .viz-note-item__dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .viz-note-item__context { font-size: var(--text-xs); font-weight: 600; color: var(--gray-600); }
        .viz-note-item__meta { font-size: var(--text-xs); color: var(--gray-400); margin-left: auto; }
        .viz-note-item__text { font-size: var(--text-sm); color: var(--gray-700); line-height: var(--leading-normal); }
        
        /* ============================================================
           COMMENTS
           ============================================================ */
        .comments-section { border-top: var(--border); padding-top: var(--space-4); }
        .comments-table { background: white; border: 1px solid var(--gray-100); border-radius: var(--radius-sm); overflow: hidden; }
        .comments-table-empty { padding: var(--space-4); text-align: center; color: var(--gray-400); font-size: var(--text-sm); }
        
        .comment-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--gray-75);
            align-items: start;
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        .comment-row:last-child { border-bottom: none; }
        .comment-row:hover { background: var(--gray-50); }
        .comment-row__context { display: flex; align-items: center; gap: var(--space-1); font-size: var(--text-xs); font-weight: 600; color: var(--gray-600); white-space: nowrap; min-width: 100px; }
        .comment-row__dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .comment-row__text { font-size: var(--text-sm); color: var(--gray-700); line-height: var(--leading-normal); }
        .comment-row__meta { font-size: var(--text-xs); color: var(--gray-400); white-space: nowrap; }
        .comment-row--general .comment-row__context { color: var(--gray-400); }
        
        /* ============================================================
           EDITABLE MARKDOWN
           ============================================================ */
        .editable-markdown {
            position: relative;
            min-height: 80px;
            background: white;
            border: 1px solid var(--gray-100);
            border-radius: var(--radius-sm);
            cursor: text;
            transition: all var(--transition-fast);
        }
        .editable-markdown:hover { border-color: var(--gray-300); background: var(--gray-50); }
        .editable-markdown:hover::after {
            content: 'Click to edit';
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            color: var(--gray-500);
            background: white;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
        }
        .editable-markdown__display { padding: var(--space-3); min-height: 80px; }
        .editable-markdown__display:empty::before { content: 'Click to add description...'; color: var(--gray-400); }
        .editable-markdown__editor { display: none; min-height: 80px; border: none; border-radius: var(--radius-sm); }
        .editable-markdown__editor:focus { box-shadow: none; border: none; }
        .editable-markdown.editing { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
        .editable-markdown.editing:hover::after { display: none; }
        .editable-markdown.editing .editable-markdown__display { display: none; }
        .editable-markdown.editing .editable-markdown__editor { display: block; }
        
        /* ============================================================
           AI PANEL
           ============================================================ */
        .ai-panel { display: none; margin-top: var(--space-2); padding: var(--space-3); background: var(--gray-50); border: var(--border); border-radius: var(--radius-md); }
        .ai-panel.open { display: block; }
        .ai-panel__input { width: 100%; min-height: 50px; margin-bottom: var(--space-2); }
        .ai-panel__btn { display: flex; align-items: center; gap: var(--space-2); }
        .ai-panel__btn .spinner { display: none; width: 14px; height: 14px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .ai-panel__btn.loading .spinner { display: block; }
        .ai-panel__btn.loading .btn-text { display: none; }
        .ai-panel__actions { display: flex; align-items: center; gap: var(--space-2); }
        .ai-panel__saved { margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--gray-200); }
        .ai-panel__saved-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2); }
        .ai-panel__saved-label { font-size: var(--text-xs); font-weight: 500; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }
        .ai-panel__saved-list { display: flex; flex-direction: column; gap: var(--space-1); max-height: 150px; overflow-y: auto; }
        .ai-panel__saved-item { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2); font-size: var(--text-sm); color: var(--gray-600); background: white; border: 1px solid var(--gray-200); border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition-fast); }
        .ai-panel__saved-item:hover { border-color: var(--accent); background: var(--accent-light); }
        .ai-panel__saved-item-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .ai-panel__saved-item-delete { padding: 2px 6px; font-size: var(--text-xs); color: var(--gray-400); background: none; border: none; border-radius: var(--radius-sm); cursor: pointer; opacity: 0; transition: opacity var(--transition-fast); }
        .ai-panel__saved-item:hover .ai-panel__saved-item-delete { opacity: 1; }
        .ai-panel__saved-item-delete:hover { color: var(--error); background: rgba(220, 53, 69, 0.1); }
        .ai-panel__saved-empty { padding: var(--space-2); font-size: var(--text-xs); color: var(--gray-400); text-align: center; }
        .ai-size-select { padding: var(--space-1) var(--space-2); font-size: var(--text-xs); color: var(--gray-600); background: white; border: 1px solid var(--gray-200); border-radius: var(--radius-sm); cursor: pointer; }
        .ai-size-select:focus { outline: none; border-color: var(--accent); }
        
        .ai-panel__row { margin-bottom: var(--space-2); }
        .ai-panel__preview {
            margin-top: var(--space-3);
            padding: var(--space-3);
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
        }
        .ai-panel__preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }
        .ai-panel__preview-content {
            font-size: var(--text-xs);
            color: var(--gray-600);
            max-height: 150px;
            overflow-y: auto;
        }
        .ai-panel__preview-series {
            padding: var(--space-2);
            margin-bottom: var(--space-1);
            background: var(--gray-50);
            border-radius: var(--radius-sm);
        }
        .ai-panel__preview-series-name {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-1);
        }
        .ai-panel__preview-series-data {
            font-family: var(--font-mono);
            word-break: break-all;
        }
        .ai-panel__preview-error {
            color: var(--error);
            padding: var(--space-2);
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ============================================================
           STYLE SETTINGS
           ============================================================ */
        .style-palette { background: white; border: 1px solid var(--gray-100); border-radius: var(--radius-sm); padding: var(--space-3); }
        .palette-swatches { display: flex; gap: var(--space-2); flex-wrap: wrap; }
        .palette-swatch { width: 28px; height: 28px; border-radius: var(--radius-sm); border: 2px solid transparent; cursor: pointer; transition: all var(--transition-fast); display: flex; align-items: center; justify-content: center; font-size: var(--text-sm); color: var(--gray-400); }
        .palette-swatch:hover { transform: scale(1.1); }
        .palette-swatch.active { border-color: var(--gray-800); }
        .style-options { display: flex; flex-direction: column; gap: var(--space-2); }
        .style-option { display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-sm); color: var(--gray-600); cursor: pointer; }
        .style-option input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
        
        /* ============================================================
           CODE VIEW
           ============================================================ */
        .code-view { display: none; }
        .code-view.active { display: block; }
        .code-block { margin: 0; padding: var(--space-4); font-family: var(--font-mono); font-size: var(--text-xs); line-height: var(--leading-normal); color: var(--gray-100); background: var(--gray-800); border-radius: 0 0 var(--radius-md) var(--radius-md); overflow-x: auto; max-height: 300px; overflow-y: auto; }
        .code-block code { color: inherit; background: none; }
        
        /* ============================================================
           FILE UPLOAD
           ============================================================ */
        .file-upload { margin-bottom: var(--space-3); }
        .file-upload__dropzone {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-5);
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .file-upload__dropzone:hover,
        .file-upload__dropzone.dragover {
            border-color: var(--accent);
            background: var(--accent-light);
        }
        .file-upload__icon { 
            font-size: var(--text-lg); 
            color: var(--gray-400);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
        }
        .file-upload__text { font-size: var(--text-sm); color: var(--gray-600); }
        .file-upload__browse {
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            font-size: inherit;
            padding: 0;
        }
        .file-upload__browse:hover { color: var(--accent-dark); }
        .file-upload__hint { font-size: var(--text-xs); color: var(--gray-400); }
        
        .file-list { display: flex; flex-direction: column; gap: var(--space-2); }
        .file-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        .file-item:hover { background: var(--gray-50); }
        .file-item__icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            font-size: 9px;
            font-weight: 700;
            color: white;
            background: var(--gray-500);
            border-radius: var(--radius-sm);
            flex-shrink: 0;
            letter-spacing: -0.5px;
        }
        .file-item__info { flex: 1; min-width: 0; }
        .file-item__name { font-size: var(--text-sm); font-weight: 500; color: var(--gray-700); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-item__meta { font-size: var(--text-xs); color: var(--gray-400); }
        .file-item__actions { display: flex; gap: var(--space-1); }
        .file-item__btn {
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            color: var(--gray-500);
            background: var(--gray-100);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .file-item__btn:hover { background: var(--gray-200); color: var(--gray-700); }
        .file-item__btn--delete:hover { background: rgba(181, 72, 72, 0.1); color: var(--error); }
        .file-list-empty { padding: var(--space-3); text-align: center; font-size: var(--text-sm); color: var(--gray-400); }
        
        .file-preview-table { width: 100%; border-collapse: collapse; font-size: var(--text-xs); }
        .file-preview-table th, .file-preview-table td { padding: var(--space-1) var(--space-2); border: 1px solid var(--gray-200); text-align: left; }
        .file-preview-table th { background: var(--gray-50); font-weight: 600; position: sticky; top: 0; }
        .file-preview-table tr:hover td { background: var(--gray-50); }
        .file-preview-image { max-width: 100%; height: auto; border-radius: var(--radius-sm); }
        .file-preview-message { padding: var(--space-4); text-align: center; color: var(--gray-500); }

        /* ============================================================
           UTILITIES
           ============================================================ */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .ml-auto { margin-left: auto; }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .flex-1 { flex: 1; }
        .flex-2 { flex: 2; }
    </style>
</head>
<body>
    <div class="container">
        <!-- SLIDE SECTION -->
        <div class="section__header">
            <span class="section__title">Slide</span>
            <div class="toolbar">
                <div class="tabs">
                    <button class="tab active" data-view="output">Output</button>
                    <button class="tab" data-view="table">Table</button>
                    <button class="tab" data-view="notes">Notes <span class="tab__count" id="notes-count">0</span></button>
                </div>
                <select class="select" id="chart-type-select" style="width: auto; padding: var(--space-1) var(--space-2); font-size: var(--text-xs);">
                    <option value="line">Line</option>
                    <option value="bar">Bar</option>
                    <option value="area">Area</option>
                </select>
                <div class="toolbar__divider"></div>
                <div class="dropdown">
                    <button class="btn btn--sm" id="export-btn">Export ▾</button>
                    <div class="dropdown__menu" id="export-dropdown">
                        <div class="dropdown__section">
                            <div class="dropdown__label">Export As</div>
                            <button class="dropdown__item" data-export="png">PNG Image</button>
                            <button class="dropdown__item" data-export="pdf">PDF Document</button>
                            <button class="dropdown__item" data-export="pptx">PowerPoint</button>
                        </div>
                        <div class="dropdown__divider"></div>
                        <div class="dropdown__section">
                            <div class="dropdown__label">Copy</div>
                            <button class="dropdown__item" data-copy="csv">CSV</button>
                            <button class="dropdown__item" data-copy="markdown">Markdown</button>
                            <button class="dropdown__item" data-copy="json">JSON</button>
                        </div>
                    </div>
                </div>
                <span class="toolbar__status toolbar__status--saved" id="save-status">Saved</span>
            </div>
        </div>
        
        <div class="slide view-output" id="slide">
            <div class="slide__zone slide__title" data-zone="Title">
                <div class="slide__title-content">
                    <span class="slide__section-header" id="slide-section-header"></span>
                    <h1 id="slide-title"></h1>
                </div>
            </div>
            <div class="slide__zone slide__description" data-zone="Description">
                <div class="slide__description-content">
                    <div class="markdown" id="description-content"></div>
                </div>
            </div>
            <div class="resize-handle resize-handle--col" data-resize="col" style="grid-column: 2; grid-row: 2;"></div>
            <div class="slide__zone slide__viz" data-zone="Visualization">
                <div class="slide__viz-header">
                    <span class="slide__viz-unit">USD $</span>
                    <div class="slide__viz-legend" id="chart-legend"></div>
                </div>
                <div class="slide__viz-content">
                    <div class="viz-view active" id="viz-view-output">
                        <div class="chart-container">
                            <canvas id="chart"></canvas>
                        </div>
                    </div>
                    <div class="viz-view" id="viz-view-table">
                        <div class="viz-table-container" id="viz-table-display"></div>
                    </div>
                    <div class="viz-view" id="viz-view-notes">
                        <div class="viz-notes-container" id="viz-notes-display"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA SECTION -->
        <div class="section">
            <div class="section__header">
                <span class="section__title">Data</span>
            </div>

            <!-- Title Card -->
            <div class="card">
                <div class="card__header">
                    <span class="badge">Zone 1</span>
                    <span class="card__title">Title</span>
                </div>
                <div class="card__body">
                    <div class="field-row">
                        <div class="field field--inline" style="width: 380px; flex-shrink: 0;">
                            <label class="field__label">Section Header</label>
                            <input type="text" class="input input--underline input--muted" id="field-section-header" placeholder="e.g. Fall 2025 Presentation">
                        </div>
                        <div class="field field--inline flex-1">
                            <label class="field__label">
                                Title
                                <button class="btn-ai" data-ai="title">AI</button>
                            </label>
                            <input type="text" class="input input--underline" id="field-title" placeholder="Enter slide title...">
                        </div>
                    </div>
                    <div class="ai-panel" id="ai-title">
                        <textarea class="textarea ai-panel__input" placeholder="Enter prompt..." id="ai-prompt-title"></textarea>
                        <button class="btn btn--primary btn--sm ai-panel__btn" data-generate="title">
                            <span class="spinner"></span>
                            <span class="btn-text">Generate</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Description Card -->
            <div class="card mt-4">
                <div class="card__header">
                    <span class="badge">Zone 2</span>
                    <span class="card__title">Description</span>
                </div>
                <div class="card__body">
                    <div class="field">
                        <div class="field__label">
                            Description
                            <button class="btn-ai" data-ai="description">AI</button>
                            <select class="ai-size-select" id="ai-size-description" data-field="description">
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                        <div class="ai-panel" id="ai-description">
                            <textarea class="textarea ai-panel__input" placeholder="Enter prompt..." id="ai-prompt-description"></textarea>
                            <div class="ai-panel__actions">
                                <button class="btn btn--primary btn--sm ai-panel__btn" data-generate="description">
                                    <span class="spinner"></span>
                                    <span class="btn-text">Generate</span>
                                </button>
                                <button class="btn btn--sm" id="save-prompt-description">Save Prompt</button>
                            </div>
                            <div class="ai-panel__saved">
                                <div class="ai-panel__saved-header">
                                    <span class="ai-panel__saved-label">Saved Prompts</span>
                                </div>
                                <div class="ai-panel__saved-list" id="saved-prompts-description"></div>
                            </div>
                        </div>
                        <div class="editable-markdown" id="field-description-container">
                            <div class="editable-markdown__display markdown" id="field-description-display"></div>
                            <textarea class="editable-markdown__editor textarea textarea--auto" id="field-description" placeholder="Enter description (supports markdown)..."></textarea>
                        </div>
                    </div>
                    
                    <div class="comments-section mt-4">
                        <div class="field__label" style="margin-bottom: var(--space-2);">
                            Comments
                            <button class="btn-add" id="add-description-comment-btn" title="Add comment">+</button>
                        </div>
                        <div class="comments-table" id="description-comments-table"></div>
                    </div>
                </div>
            </div>

            <!-- Visualization Card -->
            <div class="card mt-4">
                <div class="card__header">
                    <span class="badge">Zone 3</span>
                    <span class="card__title">Visualization</span>
                </div>
                <div class="card__body">
                    <div class="field">
                        <div class="field__label">
                            Data
                            <button class="btn-ai" data-ai="visualization">AI</button>
                        </div>
                        <div class="ai-panel" id="ai-visualization">
                            <div class="ai-panel__row">
                                <label class="field__label" style="margin-bottom: var(--space-1);">Attachment</label>
                                <select class="select" id="ai-viz-attachment" style="margin-bottom: var(--space-2);">
                                    <option value="">None - describe data manually</option>
                                </select>
                            </div>
                            <textarea class="textarea ai-panel__input" placeholder="e.g. Extract monthly revenue and expenses..." id="ai-prompt-visualization"></textarea>
                            <button class="btn btn--primary btn--sm ai-panel__btn" data-generate="visualization">
                                <span class="spinner"></span>
                                <span class="btn-text">Extract</span>
                            </button>
                            <div class="ai-panel__preview" id="ai-viz-preview" style="display: none;">
                                <div class="ai-panel__preview-header">
                                    <span class="field__label">Preview</span>
                                    <button class="btn btn--sm btn--primary" id="ai-viz-apply">Apply to Chart</button>
                                </div>
                                <div class="ai-panel__preview-content" id="ai-viz-preview-content"></div>
                            </div>
                        </div>
                        <div id="data-table-container"></div>
                    </div>
                    
                    <div class="comments-section mt-4">
                        <div class="field__label" style="margin-bottom: var(--space-2);">
                            Comments
                            <button class="btn-add" id="add-comment-btn" title="Add general comment">+</button>
                        </div>
                        <div class="comments-table" id="comments-table"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal-overlay" id="comment-modal-overlay">
            <div class="modal">
                <div class="modal__header">
                    <span class="modal__title">Cell Comment</span>
                    <span class="badge" id="comment-modal-context"></span>
                    <button class="modal__close" id="comment-modal-close">×</button>
                </div>
                <div class="modal__body">
                    <textarea class="textarea" id="comment-modal-text" placeholder="Add a comment for this cell..."></textarea>
                </div>
                <div class="modal__footer">
                    <button class="btn" id="comment-modal-delete">Delete</button>
                    <button class="btn btn--primary" id="comment-modal-save">Save</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="general-comment-modal-overlay">
            <div class="modal">
                <div class="modal__header">
                    <span class="modal__title">General Comment</span>
                    <button class="modal__close" id="general-comment-modal-close">×</button>
                </div>
                <div class="modal__body">
                    <textarea class="textarea" id="general-comment-modal-text" placeholder="Add a general comment..."></textarea>
                </div>
                <div class="modal__footer">
                    <button class="btn" id="general-comment-modal-delete">Delete</button>
                    <button class="btn btn--primary" id="general-comment-modal-save">Save</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="description-comment-modal-overlay">
            <div class="modal">
                <div class="modal__header">
                    <span class="modal__title">Description Comment</span>
                    <button class="modal__close" id="description-comment-modal-close">×</button>
                </div>
                <div class="modal__body">
                    <textarea class="textarea" id="description-comment-modal-text" placeholder="Add a comment on the description..."></textarea>
                </div>
                <div class="modal__footer">
                    <button class="btn" id="description-comment-modal-delete">Delete</button>
                    <button class="btn btn--primary" id="description-comment-modal-save">Save</button>
                </div>
            </div>
        </div>

        <!-- File Preview Modal -->
        <div class="modal-overlay" id="file-preview-modal-overlay">
            <div class="modal modal--large">
                <div class="modal__header">
                    <span class="modal__title" id="file-preview-title">File Preview</span>
                    <button class="btn btn--sm" id="file-preview-download">Download</button>
                    <button class="modal__close" id="file-preview-close">×</button>
                </div>
                <div class="modal__body" id="file-preview-content" style="max-height: 60vh; overflow: auto;"></div>
            </div>
        </div>

        <!-- SETTINGS SECTION -->
        <div class="section">
            <div class="section__header">
                <span class="section__title">Settings</span>
            </div>

            <div class="card">
                <div class="card__header">
                    <span class="badge">Generation</span>
                    <span class="card__title">AI</span>
                </div>
                <div class="card__body">
                    <div class="field">
                        <div class="field__label">Context & Instructions</div>
                        <textarea class="textarea" id="ai-context" rows="3" placeholder="Add custom context for AI generation..."></textarea>
                        <div class="field__hint">This context will be included in all AI generation prompts.</div>
                    </div>
                    <div class="field mt-4">
                        <div class="field__label">Growth Calculation Rules</div>
                        <textarea class="textarea" id="ai-growth-rules" rows="4"></textarea>
                        <div class="field__hint">Rules for how AI should describe percentage changes.</div>
                    </div>
                    <div class="field mt-4">
                        <div class="field__label">Tone</div>
                        <select class="select" id="ai-tone" style="flex: 1;">
                            <option value="professional">Professional</option>
                            <option value="formal">Formal</option>
                            <option value="casual">Casual</option>
                            <option value="technical">Technical</option>
                            <option value="executive">Executive Summary</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card__header">
                    <span class="badge">Appearance</span>
                    <span class="card__title">Style</span>
                </div>
                <div class="card__body">
                    <div class="flex gap-4" style="align-items: flex-start;">
                        <div style="flex: 1;">
                            <div class="field">
                                <div class="field__label">Color Palette</div>
                                <div class="style-palette" id="style-palette">
                                    <div class="palette-swatches"></div>
                                </div>
                            </div>
                            <div class="field mt-4">
                                <div class="field__label">Chart Style</div>
                                <div class="style-options">
                                    <label class="style-option">
                                        <input type="checkbox" id="style-gridlines" checked>
                                        <span>Show gridlines</span>
                                    </label>
                                    <label class="style-option">
                                        <input type="checkbox" id="style-points" checked>
                                        <span>Show data points</span>
                                    </label>
                                    <label class="style-option">
                                        <input type="checkbox" id="style-smooth" checked>
                                        <span>Smooth lines</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <div class="field">
                                <div class="field__label">Typography</div>
                                <div class="field-row gap-3 mt-2">
                                    <div class="field field--inline" style="flex: 1;">
                                        <label class="field__label">Title Size</label>
                                        <select class="select" id="style-title-size">
                                            <option value="small">Small</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="large">Large</option>
                                        </select>
                                    </div>
                                    <div class="field field--inline" style="flex: 1;">
                                        <label class="field__label">Body Size</label>
                                        <select class="select" id="style-body-size">
                                            <option value="small">Small</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="large">Large</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="field mt-4">
                                <div class="field__label">Layout</div>
                                <div class="field-row gap-3 mt-2">
                                    <div class="field field--inline" style="flex: 1;">
                                        <label class="field__label">Description Width</label>
                                        <select class="select" id="style-desc-width">
                                            <option value="25">25%</option>
                                            <option value="35" selected>35%</option>
                                            <option value="45">45%</option>
                                        </select>
                                    </div>
                                    <div class="field field--inline" style="flex: 1;">
                                        <label class="field__label">Aspect Ratio</label>
                                        <select class="select" id="style-aspect">
                                            <option value="16/9" selected>16:9</option>
                                            <option value="4/3">4:3</option>
                                            <option value="1/1">1:1</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card__header">
                    <span class="badge">Files</span>
                    <span class="card__title">Attachments</span>
                </div>
                <div class="card__body">
                    <div class="field">
                        <div class="field__label">Upload Files</div>
                        <div class="file-upload" id="file-upload-zone">
                            <input type="file" id="file-input" multiple hidden>
                            <div class="file-upload__dropzone" id="file-dropzone">
                                <div class="file-upload__icon">+</div>
                                <div class="file-upload__text">Drop files here or <button class="file-upload__browse" id="file-browse-btn">browse</button></div>
                                <div class="file-upload__hint">Max 2MB per file • Images, PDFs, documents</div>
                            </div>
                        </div>
                        <div class="file-list" id="file-list"></div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card__header">
                    <span class="badge">Developer</span>
                    <span class="card__title">Code</span>
                    <div class="card__actions">
                        <div class="tabs">
                            <button class="tab active" data-code-view="schema">Schema</button>
                            <button class="tab" data-code-view="json">JSON</button>
                        </div>
                    </div>
                </div>
                <div class="card__body" style="padding: 0;">
                    <div class="code-view active" id="code-view-schema">
                        <pre class="code-block"><code id="schema-code">{ "record": { "id": "string", "created": "datetime", "modified": "datetime" },
  "fields": {
    "title": { "type": "text", "zone": 1, "required": true },
    "description": { "type": "richtext", "zone": 2, "required": false },
    "comments": { "type": "array<{author, text, time}>", "zone": 3, "required": false },
    "visualization": { "type": "chart_data", "zone": 3, "required": false },
    "cellComments": { "type": "map<{text, author, time}>", "zone": 3, "key": "seriesIndex-colIndex" }
  }
}</code></pre>
                    </div>
                    <div class="code-view" id="code-view-json">
                        <pre class="code-block"><code id="json-code"></code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
    // ============================================================
    // APP CONFIG & CONSTANTS
    // ============================================================
    const CONFIG = {
        STORAGE_KEY: 'proxa-record-data-v4',
        MONTHS: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        TONE_DESCRIPTIONS: {
            professional: 'professional and clear',
            formal: 'formal and authoritative',
            casual: 'conversational and approachable',
            technical: 'technical and precise',
            executive: 'high-level executive summary style'
        }
    };
    
    // ============================================================
    // DATE SERVICE - Normalize and format dates
    // ============================================================
    const DateService = {
        // Parse any date string into normalized object
        parse(input) {
            if (!input) return null;
            const str = String(input).trim();
            
            // Already ISO format: 2024-01-15 or 2024-01
            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                const [y, m] = str.split('-');
                return { iso: str, year: y, month: parseInt(m), granularity: 'month', display: `${CONFIG.MONTHS[parseInt(m)-1]} '${y.slice(2)}` };
            }
            if (/^\d{4}-\d{2}$/.test(str)) {
                const [y, m] = str.split('-');
                return { iso: str, year: y, month: parseInt(m), granularity: 'month', display: `${CONFIG.MONTHS[parseInt(m)-1]} '${y.slice(2)}` };
            }
            
            // Year only: 2024
            if (/^\d{4}$/.test(str)) {
                return { iso: str, year: str, month: null, granularity: 'year', display: str };
            }
            
            // Fiscal year: FY24, FY2024
            const fyMatch = str.match(/^FY\s*(\d{2,4})$/i);
            if (fyMatch) {
                const y = fyMatch[1].length === 2 ? '20' + fyMatch[1] : fyMatch[1];
                return { iso: y, year: y, month: null, granularity: 'fiscal', display: `FY${y.slice(2)}` };
            }
            
            // Quarter: Q1 2024, 2024 Q1, Q1'24
            const qMatch = str.match(/Q([1-4])\s*'?(\d{2,4})|(\d{4})\s*Q([1-4])/i);
            if (qMatch) {
                const q = qMatch[1] || qMatch[4];
                let y = qMatch[2] || qMatch[3];
                if (y.length === 2) y = '20' + y;
                const qMonth = (parseInt(q) - 1) * 3 + 1;
                return { iso: `${y}-Q${q}`, year: y, quarter: parseInt(q), month: qMonth, granularity: 'quarter', display: `Q${q} ${y}` };
            }
            
            // Month Year: Jan 2024, January 2024, Jan '24, Jan-24
            const monthMatch = str.match(/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*[\s\-']?'?(\d{2,4})$/i);
            if (monthMatch) {
                const mIdx = CONFIG.MONTHS.findIndex(m => m.toLowerCase() === monthMatch[1].toLowerCase().slice(0, 3));
                let y = monthMatch[2];
                if (y.length === 2) y = '20' + y;
                const m = String(mIdx + 1).padStart(2, '0');
                return { iso: `${y}-${m}`, year: y, month: mIdx + 1, granularity: 'month', display: `${CONFIG.MONTHS[mIdx]} '${y.slice(2)}` };
            }
            
            // Fallback - return as-is
            return { iso: str, year: null, month: null, granularity: 'unknown', display: str };
        },
        
        // Detect granularity from array of labels
        detectGranularity(labels) {
            if (!labels || labels.length === 0) return 'month';
            const parsed = labels.map(l => this.parse(l));
            const granularities = parsed.map(p => p?.granularity).filter(Boolean);
            
            if (granularities.includes('quarter')) return 'quarter';
            if (granularities.includes('fiscal')) return 'fiscal';
            if (granularities.every(g => g === 'year')) return 'year';
            return 'month';
        },
        
        // Format for display based on granularity
        format(input, style = 'short') {
            const parsed = typeof input === 'object' ? input : this.parse(input);
            if (!parsed) return '';
            
            if (style === 'full') {
                if (parsed.granularity === 'month' && parsed.month) {
                    return `${CONFIG.MONTHS[parsed.month - 1]} ${parsed.year}`;
                }
                return parsed.display;
            }
            return parsed.display;
        },
        
        // Generate picker options based on granularity and year
        getPickerOptions(granularity, year) {
            const y = year || new Date().getFullYear();
            const options = [];
            
            if (granularity === 'year') {
                for (let i = y - 5; i <= y + 5; i++) {
                    options.push({ value: String(i), label: String(i) });
                }
            } else if (granularity === 'quarter') {
                for (let i = y - 2; i <= y + 2; i++) {
                    for (let q = 1; q <= 4; q++) {
                        options.push({ value: `${i}-Q${q}`, label: `Q${q} ${i}` });
                    }
                }
            } else if (granularity === 'fiscal') {
                for (let i = y - 5; i <= y + 5; i++) {
                    options.push({ value: String(i), label: `FY${String(i).slice(2)}` });
                }
            } else {
                // Monthly - show 3 years
                for (let i = y - 1; i <= y + 1; i++) {
                    for (let m = 0; m < 12; m++) {
                        const val = `${i}-${String(m + 1).padStart(2, '0')}`;
                        options.push({ value: val, label: `${CONFIG.MONTHS[m]} '${String(i).slice(2)}` });
                    }
                }
            }
            return options;
        },
        
        // Normalize an array of labels to consistent format
        normalizeLabels(labels) {
            return labels.map(l => {
                const parsed = this.parse(l);
                return parsed?.iso || l;
            });
        }
    };
    
    // ============================================================
    // STATE
    // ============================================================
    const DEFAULT_STATE = {
        sectionHeader: 'Fall 2025 Management Presentation - Finance',
        title: 'Financial Performance 2024',
        description: '## Key Highlights\n\n**Revenue growth** of 108% year-over-year demonstrates strong market position.\n\n### Trends\n- Consistent upward trajectory across all quarters\n- Expenses scaling efficiently with revenue\n- Profit margins expanding in H2',
        descriptionComments: [],
        comments: [{ text: 'Great progress on cost management this quarter.', author: 'Finance Team', time: 'Dec 1, 9:00 AM' }],
        aiSettings: { 
            context: '', 
            tone: 'professional',
            growthRules: `If a value goes from negative to positive, do NOT calculate percentage growth. Instead say "turned positive" or "improved from -$X to +$Y".
If a value goes from positive to negative, say "declined to a loss of $X".
Only calculate percentage growth when both start and end values have the same sign.
For metrics that swing between negative and positive, focus on absolute change rather than percentage.`
        },
        lastPrompts: { title: '', description: '' },
        savedPrompts: { description: [] },
        attachments: [],
        chart: {
            type: 'line',
            labels: ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06', '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12'],
            series: [
                { name: 'Revenue', color: '#4a6fa5', data: [1236577, 1425890, 1312445, 1567234, 1489012, 1723456, 1856789, 1645321, 1934567, 2123456, 2345678, 2567890] },
                { name: 'Expenses', color: '#6b8f71', data: [856234, 912456, 878901, 1023456, 989123, 1145678, 1234567, 1098765, 1289012, 1412345, 1534567, 1678901] },
                { name: 'Profit', color: '#c9a227', data: [380343, 513434, 433544, 543778, 499889, 577778, 622222, 546556, 645555, 711111, 811111, 888989] }
            ],
            cellComments: {
                '0-2': { text: 'Q1 close - slight revenue dip due to seasonal adjustment', author: 'You', time: 'Jan 15, 10:30 AM' },
                '0-5': { text: 'New product launch drove revenue spike', author: 'You', time: 'Jun 20, 2:15 PM' },
                '2-11': { text: 'Year-end strong performance, exceeded targets', author: 'Finance Team', time: 'Dec 1, 9:00 AM' }
            }
        }
    };
    
    let state = { ...DEFAULT_STATE };
    let chart = null;
    let currentModal = { type: null, data: null };
    let pendingExtraction = null; // Holds extracted data before applying
    
    // ============================================================
    // UTILITIES
    // ============================================================
    const Utils = {
        formatNumber: (num) => num.toLocaleString('en-US'),
        parseNumber: (str) => parseFloat(String(str).replace(/,/g, '')) || 0,
        hexToRgba: (hex, alpha) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        },
        getTimeString: () => new Date().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }),
        debounce: (fn, ms) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), ms);
            };
        },
        parseMarkdown: (text) => typeof marked !== 'undefined' && text ? marked.parse(text) : text || '',
        formatFileSize: (bytes) => {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        },
        getFileIcon: (type, name) => {
            const ext = name?.split('.').pop()?.toUpperCase() || '';
            if (type.startsWith('image/')) return { label: ext || 'IMG', color: '#4a6fa5' };
            if (type === 'application/pdf') return { label: 'PDF', color: '#b54848' };
            if (type.includes('spreadsheet') || type.includes('excel') || ext === 'XLSX' || ext === 'XLS' || ext === 'CSV') return { label: ext || 'XLS', color: '#6b8f71' };
            if (type.includes('document') || type.includes('word') || ext === 'DOCX' || ext === 'DOC') return { label: ext || 'DOC', color: '#4a6fa5' };
            if (type.includes('presentation') || type.includes('powerpoint') || ext === 'PPTX' || ext === 'PPT') return { label: ext || 'PPT', color: '#c9a227' };
            if (type.startsWith('text/') || ext === 'TXT' || ext === 'MD') return { label: ext || 'TXT', color: '#78716c' };
            return { label: ext || 'FILE', color: '#78716c' };
        },
        generateId: () => Math.random().toString(36).substr(2, 9),
        parseCSV: (text) => {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) return null;
            
            // Detect delimiter
            const firstLine = lines[0];
            const delimiter = firstLine.includes('\t') ? '\t' : ',';
            
            const headers = firstLine.split(delimiter).map(h => h.trim().replace(/^["']|["']$/g, ''));
            const rows = lines.slice(1).map(line => {
                return line.split(delimiter).map(cell => cell.trim().replace(/^["']|["']$/g, ''));
            });
            
            return { headers, rows };
        },
        $(id) { return document.getElementById(id); },
        $$(selector) { return document.querySelectorAll(selector); }
    };
    
    // ============================================================
    // DATA HELPERS
    // ============================================================
    function getChartData() {
        const { labels, series } = state.chart;
        const granularity = DateService.detectGranularity(labels);
        
        return {
            labels: labels.map((raw, i) => {
                const parsed = DateService.parse(raw);
                return {
                    raw,
                    iso: parsed?.iso || raw,
                    display: parsed?.display || raw,
                    full: DateService.format(parsed, 'full'),
                    granularity: parsed?.granularity || 'unknown',
                    index: i
                };
            }),
            series: series.map(s => ({
                name: s.name,
                color: s.color,
                data: [...s.data],
                total: s.data.reduce((a, b) => a + b, 0)
            })),
            granularity
        };
    }
    
    function getDescriptionBudget() {
        const container = document.querySelector('.slide__description-content');
        if (!container) return { chars: 300, words: 50, lines: 10 };
        const linesAvailable = Math.floor(container.clientHeight / 21);
        const charsPerLine = Math.floor(container.clientWidth / 7);
        const effectiveChars = Math.floor(linesAvailable * charsPerLine * 0.7);
        return { chars: effectiveChars, words: Math.floor(effectiveChars / 5), lines: linesAvailable };
    }
    
    // ============================================================
    // UI HELPERS
    // ============================================================
    function showToast(message, duration = 2500) {
        const toast = Utils.$('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }
    
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.max(80, textarea.scrollHeight) + 'px';
    }
    
    function checkDescriptionOverflow() {
        const container = document.querySelector('.slide__description-content');
        if (!container) return;
        container.classList.remove('has-overflow');
        const hasOverflow = container.scrollHeight > container.clientHeight + 5;
        container.classList.toggle('has-overflow', hasOverflow);
    }
    
    // ============================================================
    // PERSISTENCE
    // ============================================================
    const saveState = Utils.debounce(() => {
        const statusEl = Utils.$('save-status');
        statusEl.textContent = 'Saving...';
        statusEl.className = 'toolbar__status toolbar__status--saving';
        
        try {
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state));
            setTimeout(() => {
                statusEl.textContent = 'Saved';
                statusEl.className = 'toolbar__status toolbar__status--saved';
            }, 300);
        } catch (e) {
            statusEl.textContent = 'Save failed';
            statusEl.className = 'toolbar__status';
        }
    }, 500);
    
    function loadState() {
        try {
            const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...DEFAULT_STATE, ...parsed };
                
                // Migration: columnNotes to cellComments
                if (state.chart.columnNotes && !state.chart.cellComments) {
                    state.chart.cellComments = {};
                    Object.entries(state.chart.columnNotes).forEach(([colIndex, text]) => {
                        state.chart.cellComments[`0-${colIndex}`] = { text, author: 'Migrated', time: Utils.getTimeString() };
                    });
                    delete state.chart.columnNotes;
                }
                
                // Ensure required properties exist
                state.chart.cellComments = state.chart.cellComments || {};
                state.aiSettings = state.aiSettings || {};
                state.aiSettings.context = state.aiSettings.context || '';
                state.aiSettings.tone = state.aiSettings.tone || 'professional';
                state.aiSettings.growthRules = state.aiSettings.growthRules || DEFAULT_STATE.aiSettings.growthRules;
                state.descriptionComments = state.descriptionComments || [];
                state.lastPrompts = state.lastPrompts || { title: '', description: '' };
                state.savedPrompts = state.savedPrompts || { description: [] };
                state.attachments = state.attachments || [];
            }
        } catch (e) { console.error('Failed to load state:', e); }
    }
    
    // ============================================================
    // RENDER FUNCTIONS
    // ============================================================
    function renderSlide() {
        Utils.$('slide-section-header').textContent = state.sectionHeader || '';
        Utils.$('slide-title').textContent = state.title || 'Untitled';
        Utils.$('description-content').innerHTML = Utils.parseMarkdown(state.description);
        requestAnimationFrame(checkDescriptionOverflow);
    }
    
    function renderChart() {
        const data = getChartData();
        const ctx = Utils.$('chart').getContext('2d');
        
        if (!chart) {
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 15, right: 8, bottom: 5, left: 5 } },
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false }, tooltip: { titleFont: { size: 11 }, bodyFont: { size: 10 }, padding: 8 } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 9 } } },
                        y: { beginAtZero: true, grid: { color: '#e5e5e5' }, ticks: { font: { size: 9 } } }
                    }
                }
            });
        }
        
        const chartType = state.chart.type;
        chart.data.labels = data.labels.map(l => l.display);
        chart.data.datasets = data.series.map(s => ({
            label: s.name,
            data: s.data,
            borderColor: s.color,
            backgroundColor: chartType === 'area' ? Utils.hexToRgba(s.color, 0.3) : chartType === 'bar' ? s.color : Utils.hexToRgba(s.color, 0.15),
            borderWidth: chartType === 'bar' ? 0 : 1.5,
            fill: chartType === 'area',
            tension: 0.3,
            pointBackgroundColor: s.color,
            pointRadius: 2,
            pointHoverRadius: 4
        }));
        
        chart.config.type = chartType === 'area' ? 'line' : chartType;
        chart.update();
        
        Utils.$('chart-legend').innerHTML = data.series
            .map(s => `<div class="legend-item"><span class="legend-color" style="background:${s.color}"></span><span>${s.name}</span></div>`)
            .join('');
    }
    
    function renderTable(container, options = {}) {
        const { mode = 'view', showTotals = true } = options;
        const data = getChartData();
        const { labels, series } = state.chart;
        const cellComments = state.chart.cellComments || {};
        const isEdit = mode === 'edit';
        
        let html = '<div class="data-table-wrap"><table class="data-table"><thead><tr><th></th>';
        
        data.labels.forEach((l, i) => {
            if (isEdit) {
                // Get picker options based on detected granularity
                const options = DateService.getPickerOptions(data.granularity, l.iso?.slice?.(0,4) || new Date().getFullYear());
                html += `<th class="col-header"><select data-col="${i}" class="col-date-select">`;
                options.forEach(opt => {
                    const selected = opt.value === l.iso || opt.label === l.display ? 'selected' : '';
                    html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
                });
                html += '</select></th>';
            } else {
                html += `<th class="col-header">${l.display}</th>`;
            }
        });
        
        if (showTotals) html += '<th class="col-header total-col">Total</th>';
        html += '</tr></thead><tbody>';
        
        series.forEach((s, si) => {
            const seriesData = data.series[si];
            html += '<tr><td><div class="series-label">';
            
            if (isEdit) {
                html += `<input type="color" class="color-picker" data-series="${si}" value="${s.color}">`;
                html += `<input type="text" class="series-name-input" data-series="${si}" value="${s.name}">`;
            } else {
                html += `<span class="series-dot" style="background:${s.color}"></span><span>${s.name}</span>`;
            }
            html += '</div></td>';
            
            s.data.forEach((v, ci) => {
                const key = `${si}-${ci}`;
                const hasComment = cellComments[key];
                const cls = hasComment ? 'has-comment' : '';
                const title = hasComment ? cellComments[key].text.replace(/"/g, '&quot;') : '';
                
                if (isEdit) {
                    html += `<td class="value-cell ${cls}" data-cell="${key}" title="${title}">`;
                    html += `<input type="text" data-series="${si}" data-col="${ci}" value="${Utils.formatNumber(v)}">`;
                    if (hasComment) html += '<span class="comment-dot"></span>';
                    html += '</td>';
                } else {
                    html += `<td class="${cls}" title="${title}">${Utils.formatNumber(v)}`;
                    if (hasComment) html += '<span class="comment-dot"></span>';
                    html += '</td>';
                }
            });
            
            if (showTotals) html += `<td class="total-col">${Utils.formatNumber(seriesData.total)}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    function renderVizNotes() {
        const container = Utils.$('viz-notes-display');
        const cellComments = state.chart.cellComments || {};
        
        const cellEntries = Object.entries(cellComments).map(([key, comment]) => {
            const [si, ci] = key.split('-').map(Number);
            const labelRaw = state.chart.labels[ci];
            const parsed = DateService.parse(labelRaw);
            return {
                type: 'cell',
                seriesName: state.chart.series[si]?.name || 'Unknown',
                seriesColor: state.chart.series[si]?.color || '#999',
                monthFull: DateService.format(parsed, 'full'),
                colIndex: ci,
                seriesIndex: si,
                ...comment
            };
        }).sort((a, b) => a.colIndex - b.colIndex || a.seriesIndex - b.seriesIndex);
        
        const generalEntries = state.comments.filter(c => c.text.trim()).map(c => ({ type: 'general', ...c }));
        const allEntries = [...cellEntries, ...generalEntries];
        
        Utils.$('notes-count').textContent = allEntries.length;
        
        if (!allEntries.length) {
            container.innerHTML = '<div class="viz-notes-empty">No comments yet</div>';
            return;
        }
        
        container.innerHTML = allEntries.map(e => `
            <div class="viz-note-item${e.type === 'general' ? ' viz-note-item--general' : ''}">
                <div class="viz-note-item__header">
                    <span class="viz-note-item__dot" style="background:${e.type === 'cell' ? e.seriesColor : 'var(--gray-400)'}"></span>
                    <span class="viz-note-item__context">${e.type === 'cell' ? `${e.seriesName}, ${e.monthFull}` : 'General'}</span>
                    <span class="viz-note-item__meta">${e.author}</span>
                </div>
                <div class="viz-note-item__text">${e.text}</div>
            </div>
        `).join('');
    }
    
    function renderCommentsTable(containerId, comments, type, emptyMsg) {
        const container = Utils.$(containerId);
        const filtered = comments.filter(c => c.text?.trim());
        
        if (!filtered.length) {
            container.innerHTML = `<div class="comments-table-empty">${emptyMsg}</div>`;
            return;
        }
        
        container.innerHTML = filtered.map((c, i) => `
            <div class="comment-row${type === 'general' ? ' comment-row--general' : ''}" data-type="${type}" data-index="${c.index ?? i}" ${c.key ? `data-key="${c.key}"` : ''}>
                <div class="comment-row__context">
                    <span class="comment-row__dot" style="background:${c.seriesColor || 'var(--gray-400)'}"></span>
                    ${c.context || 'Comment'}
                </div>
                <div class="comment-row__text">${c.text}</div>
                <div class="comment-row__meta">${c.author}, ${c.time}</div>
            </div>
        `).join('');
    }
    
    function renderAllComments() {
        // Viz comments (cell + general)
        const cellComments = state.chart.cellComments || {};
        const cellEntries = Object.entries(cellComments).map(([key, comment]) => {
            const [si, ci] = key.split('-').map(Number);
            const labelRaw = state.chart.labels[ci];
            const parsed = DateService.parse(labelRaw);
            return {
                type: 'cell',
                key,
                context: `${state.chart.series[si]?.name || 'Unknown'}, ${DateService.format(parsed, 'full')}`,
                seriesColor: state.chart.series[si]?.color || '#999',
                ...comment
            };
        });
        
        const generalEntries = state.comments.map((c, i) => ({
            type: 'general',
            index: i,
            context: 'General',
            ...c
        }));
        
        renderCommentsTable('comments-table', [...cellEntries, ...generalEntries], 'mixed', 'Click any data cell to add a comment, or use + for general comments');
        
        // Description comments
        const descEntries = (state.descriptionComments || []).map((c, i) => ({ ...c, index: i }));
        renderCommentsTable('description-comments-table', descEntries, 'description', 'No comments yet');
    }
    
    function renderEditorFields() {
        Utils.$('field-section-header').value = state.sectionHeader || '';
        Utils.$('field-title').value = state.title;
        Utils.$('field-description').value = state.description;
        Utils.$('field-description-display').innerHTML = Utils.parseMarkdown(state.description);
        autoResizeTextarea(Utils.$('field-description'));
    }
    
    function renderPaletteSwatches() {
        const container = document.querySelector('.palette-swatches');
        container.innerHTML = state.chart.series.map((s, i) => 
            `<div class="palette-swatch" style="background: ${s.color}" data-index="${i}" title="${s.name}"></div>`
        ).join('') + `<div class="palette-swatch" style="background: var(--gray-100); border: 1px dashed var(--gray-300);" data-action="add" title="Add color">+</div>`;
    }
    
    function renderAISettings() {
        Utils.$('ai-context').value = state.aiSettings?.context || '';
        Utils.$('ai-tone').value = state.aiSettings?.tone || 'professional';
        Utils.$('ai-growth-rules').value = state.aiSettings?.growthRules || '';
        
        if (state.lastPrompts?.title) Utils.$('ai-prompt-title').value = state.lastPrompts.title;
        if (state.lastPrompts?.description) Utils.$('ai-prompt-description').value = state.lastPrompts.description;
        
        renderSavedPrompts('description');
    }
    
    function renderSavedPrompts(field) {
        const container = Utils.$('saved-prompts-' + field);
        if (!container) return;
        
        const prompts = state.savedPrompts?.[field] || [];
        if (!prompts.length) {
            container.innerHTML = '<div class="ai-panel__saved-empty">No saved prompts yet</div>';
            return;
        }
        
        container.innerHTML = prompts.map((prompt, i) => `
            <div class="ai-panel__saved-item" data-field="${field}" data-index="${i}">
                <span class="ai-panel__saved-item-text">${prompt}</span>
                <button class="ai-panel__saved-item-delete" data-delete="${i}">×</button>
            </div>
        `).join('');
    }
    
    function renderAll() {
        renderSlide();
        renderChart();
        renderTable(Utils.$('viz-table-display'), { mode: 'view' });
        renderTable(Utils.$('data-table-container'), { mode: 'edit' });
        renderVizNotes();
        renderAllComments();
        renderEditorFields();
        renderPaletteSwatches();
        renderAISettings();
        renderAttachments();
        updateVizAttachmentDropdown();
    }
    
    // ============================================================
    // MODAL MANAGEMENT
    // ============================================================
    function openModal(type, data = {}) {
        currentModal = { type, data };
        const overlay = Utils.$(`${type}-modal-overlay`);
        const textEl = Utils.$(`${type}-modal-text`);
        
        if (type === 'comment') {
            const { seriesIndex, colIndex } = data;
            const key = `${seriesIndex}-${colIndex}`;
            const seriesName = state.chart.series[seriesIndex].name;
            const labelRaw = state.chart.labels[colIndex];
            const parsed = DateService.parse(labelRaw);
            Utils.$('comment-modal-context').textContent = `${seriesName} • ${DateService.format(parsed, 'full')}`;
            const existing = state.chart.cellComments?.[key];
            textEl.value = existing?.text || '';
            currentModal.data.key = key;
        } else if (type === 'general-comment') {
            const existing = data.index >= 0 ? state.comments[data.index] : null;
            textEl.value = existing?.text || '';
        } else if (type === 'description-comment') {
            const existing = data.index >= 0 ? state.descriptionComments?.[data.index] : null;
            textEl.value = existing?.text || '';
        }
        
        overlay.classList.add('open');
        textEl.focus();
    }
    
    function closeModal(type) {
        Utils.$(`${type}-modal-overlay`).classList.remove('open');
        currentModal = { type: null, data: null };
    }
    
    function saveModal(type) {
        const text = Utils.$(`${type}-modal-text`).value.trim();
        
        if (type === 'comment') {
            const { key } = currentModal.data;
            if (!state.chart.cellComments) state.chart.cellComments = {};
            if (text) {
                state.chart.cellComments[key] = { text, author: 'You', time: Utils.getTimeString() };
            } else {
                delete state.chart.cellComments[key];
            }
        } else if (type === 'general-comment') {
            const { index } = currentModal.data;
            if (index === -1) {
                if (text) state.comments.push({ text, author: 'You', time: Utils.getTimeString() });
            } else {
                if (text) state.comments[index].text = text;
                else state.comments.splice(index, 1);
            }
        } else if (type === 'description-comment') {
            const { index } = currentModal.data;
            if (!state.descriptionComments) state.descriptionComments = [];
            if (index === -1) {
                if (text) state.descriptionComments.push({ text, author: 'You', time: Utils.getTimeString() });
            } else {
                if (text) state.descriptionComments[index].text = text;
                else state.descriptionComments.splice(index, 1);
            }
        }
        
        renderTable(Utils.$('data-table-container'), { mode: 'edit' });
        renderTable(Utils.$('viz-table-display'), { mode: 'view' });
        renderAllComments();
        renderVizNotes();
        saveState();
        closeModal(type);
    }
    
    function deleteModal(type) {
        if (type === 'comment') {
            delete state.chart.cellComments?.[currentModal.data.key];
        } else if (type === 'general-comment' && currentModal.data.index >= 0) {
            state.comments.splice(currentModal.data.index, 1);
        } else if (type === 'description-comment' && currentModal.data.index >= 0) {
            state.descriptionComments?.splice(currentModal.data.index, 1);
        }
        
        renderTable(Utils.$('data-table-container'), { mode: 'edit' });
        renderTable(Utils.$('viz-table-display'), { mode: 'view' });
        renderAllComments();
        renderVizNotes();
        saveState();
        closeModal(type);
    }
    
    // ============================================================
    // AI GENERATION
    // ============================================================
    async function generateAI(field, size = null) {
        const promptEl = Utils.$('ai-prompt-' + field);
        const prompt = promptEl.value.trim();
        if (!prompt) return;
        
        if (!state.lastPrompts) state.lastPrompts = {};
        state.lastPrompts[field] = prompt;
        saveState();
        
        const btn = promptEl.closest('.ai-panel').querySelector('.ai-panel__btn');
        btn.classList.add('loading');
        btn.disabled = true;
        
        const data = getChartData();
        const aiContext = state.aiSettings?.context || '';
        const aiTone = state.aiSettings?.tone || 'professional';
        const growthRules = state.aiSettings?.growthRules || '';
        
        // Smart growth calculation helper
        function calcGrowth(startVal, endVal) {
            const start = startVal || 0;
            const end = endVal || 0;
            
            // Negative to positive
            if (start < 0 && end >= 0) {
                return `turned positive (from ${Utils.formatNumber(start)} to +${Utils.formatNumber(end)})`;
            }
            // Positive to negative
            if (start >= 0 && end < 0) {
                return `declined to loss (from ${Utils.formatNumber(start)} to ${Utils.formatNumber(end)})`;
            }
            // Both same sign - calculate percentage
            if (start !== 0) {
                const pct = ((end - start) / Math.abs(start) * 100).toFixed(1);
                return `${pct}% growth`;
            }
            return 'N/A';
        }
        
        let baseContext = 'You are helping populate fields in a financial metrics slide.\n\n';
        if (aiContext) baseContext += `Custom Context:\n${aiContext}\n\n`;
        if (growthRules) baseContext += `Growth Calculation Rules:\n${growthRules}\n\n`;
        baseContext += `Tone: Write in a ${CONFIG.TONE_DESCRIPTIONS[aiTone]} tone.\n\n`;
        baseContext += `Data Context:\nTitle: ${state.title || '(empty)'}\nPeriods: ${data.labels.map(l => l.full).join(', ')}\nData:\n`;
        data.series.forEach(s => {
            const growth = calcGrowth(s.data[0], s.data[s.data.length - 1]);
            baseContext += `  ${s.name}: Total=${Utils.formatNumber(s.total)}, ${growth}\n`;
        });
        
        try {
            let sysPrompt, maxTokens;
            
            if (field === 'title') {
                sysPrompt = baseContext + `\nGenerate a short professional title (max 10 words).\nOnly return the title, no explanations.\n\nPrompt: ${prompt}`;
                maxTokens = 100;
            } else if (field === 'description') {
                const budget = getDescriptionBudget();
                const sizes = {
                    small: { words: Math.floor(budget.words * 0.4), lines: Math.floor(budget.lines * 0.4) },
                    medium: { words: Math.floor(budget.words * 0.7), lines: Math.floor(budget.lines * 0.7) },
                    large: { words: budget.words, lines: budget.lines }
                };
                const activeSize = size || Utils.$('ai-size-description').value;
                const limit = sizes[activeSize];
                
                sysPrompt = baseContext + `\nGenerate content for description.\nSTRICT LIMIT: Maximum ${limit.words} words. This MUST fit in ${limit.lines} lines. Be extremely concise. Use **bold** for emphasis. Do NOT use bullet points or lists - write in short paragraphs only.\nOnly return the content, no explanations.\n\nPrompt: ${prompt}`;
                maxTokens = 500;
            }
            
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: maxTokens, messages: [{ role: 'user', content: sysPrompt }] })
            });
            const result = await response.json();
            const content = result.content[0].text.trim();
            
            if (field === 'title') {
                state.title = content;
                Utils.$('field-title').value = content;
            } else if (field === 'description') {
                state.description = content;
                const ta = Utils.$('field-description');
                ta.value = content;
                autoResizeTextarea(ta);
            }
            
            renderSlide();
            saveState();
            showToast('Generated ' + (size || 'content'));
        } catch (e) {
            console.error(e);
            showToast('Error generating content');
        } finally {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }
    
    // ============================================================
    // PROMPT MANAGEMENT
    // ============================================================
    function savePrompt(field) {
        const text = Utils.$('ai-prompt-' + field).value.trim();
        if (!text) return;
        
        if (!state.savedPrompts) state.savedPrompts = {};
        if (!state.savedPrompts[field]) state.savedPrompts[field] = [];
        if (state.savedPrompts[field].includes(text)) {
            showToast('Prompt already saved');
            return;
        }
        
        state.savedPrompts[field].push(text);
        saveState();
        renderSavedPrompts(field);
        showToast('Prompt saved');
    }
    
    // ============================================================
    // FILE ATTACHMENTS
    // ============================================================
    const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB
    const ALLOWED_TYPES = [
        'image/jpeg', 'image/png', 'image/gif', 'image/webp',
        'application/pdf',
        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'text/plain', 'text/csv'
    ];
    
    function handleFiles(files) {
        const fileArray = Array.from(files);
        let addedCount = 0;
        
        fileArray.forEach(file => {
            // Validate size
            if (file.size > MAX_FILE_SIZE) {
                showToast(`${file.name} exceeds 2MB limit`);
                return;
            }
            
            // Validate type (be permissive)
            const isAllowed = ALLOWED_TYPES.some(t => file.type.includes(t.split('/')[1])) || 
                              file.type.startsWith('image/') || 
                              file.type.startsWith('text/');
            
            if (!isAllowed && file.type) {
                showToast(`${file.name}: unsupported file type`);
                return;
            }
            
            // Read and store file
            const reader = new FileReader();
            reader.onload = (e) => {
                const attachment = {
                    id: Utils.generateId(),
                    name: file.name,
                    type: file.type || 'application/octet-stream',
                    size: file.size,
                    data: e.target.result, // base64
                    addedAt: Utils.getTimeString()
                };
                
                if (!state.attachments) state.attachments = [];
                state.attachments.push(attachment);
                addedCount++;
                
                renderAttachments();
                saveState();
                
                if (addedCount === fileArray.length) {
                    showToast(`Added ${addedCount} file${addedCount > 1 ? 's' : ''}`);
                }
            };
            reader.readAsDataURL(file);
        });
    }
    
    function removeAttachment(id) {
        state.attachments = state.attachments.filter(a => a.id !== id);
        renderAttachments();
        saveState();
        showToast('File removed');
    }
    
    function downloadAttachment(id) {
        const attachment = state.attachments.find(a => a.id === id);
        if (!attachment) return;
        
        const link = document.createElement('a');
        link.href = attachment.data;
        link.download = attachment.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    let currentPreviewId = null;
    
    function previewAttachment(id) {
        const attachment = state.attachments.find(a => a.id === id);
        if (!attachment) return;
        
        currentPreviewId = id;
        Utils.$('file-preview-title').textContent = attachment.name;
        const content = Utils.$('file-preview-content');
        
        const name = attachment.name.toLowerCase();
        const type = attachment.type.toLowerCase();
        
        // Image preview
        if (type.startsWith('image/')) {
            content.innerHTML = `<img src="${attachment.data}" class="file-preview-image" alt="${attachment.name}">`;
        }
        // Spreadsheet preview
        else if (name.endsWith('.csv') || name.endsWith('.tsv') || name.endsWith('.xlsx') || name.endsWith('.xls') || type.includes('spreadsheet') || type.includes('excel')) {
            try {
                const base64Data = attachment.data.split(',')[1];
                let csvText;
                
                if (name.endsWith('.xlsx') || name.endsWith('.xls') || type.includes('spreadsheet') || type.includes('excel')) {
                    const binaryStr = atob(base64Data);
                    const workbook = XLSX.read(binaryStr, { type: 'binary' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    csvText = XLSX.utils.sheet_to_csv(firstSheet);
                } else {
                    csvText = atob(base64Data);
                }
                
                const parsed = Utils.parseCSV(csvText);
                if (parsed && parsed.rows.length > 0) {
                    let html = '<table class="file-preview-table"><thead><tr>';
                    parsed.headers.forEach(h => html += `<th>${h}</th>`);
                    html += '</tr></thead><tbody>';
                    parsed.rows.slice(0, 100).forEach(row => {
                        html += '<tr>';
                        row.forEach(cell => html += `<td>${cell}</td>`);
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                    if (parsed.rows.length > 100) {
                        html += `<div class="file-preview-message">Showing first 100 rows of ${parsed.rows.length}</div>`;
                    }
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="file-preview-message">Could not parse spreadsheet</div>';
                }
            } catch (e) {
                console.error('Preview error:', e);
                content.innerHTML = '<div class="file-preview-message">Could not preview this file</div>';
            }
        }
        // Text preview
        else if (type.startsWith('text/') || name.endsWith('.txt') || name.endsWith('.md')) {
            try {
                const base64Data = attachment.data.split(',')[1];
                const text = atob(base64Data);
                content.innerHTML = `<pre style="white-space: pre-wrap; font-size: var(--text-xs);">${text.substring(0, 5000)}${text.length > 5000 ? '\n\n... truncated' : ''}</pre>`;
            } catch (e) {
                content.innerHTML = '<div class="file-preview-message">Could not preview this file</div>';
            }
        }
        // No preview available
        else {
            content.innerHTML = '<div class="file-preview-message">Preview not available for this file type.<br>Click Download to open.</div>';
        }
        
        Utils.$('file-preview-modal-overlay').classList.add('open');
    }
    
    function closeFilePreview() {
        Utils.$('file-preview-modal-overlay').classList.remove('open');
        currentPreviewId = null;
    }
    
    function renderAttachments() {
        const container = Utils.$('file-list');
        if (!state.attachments || !state.attachments.length) {
            container.innerHTML = '<div class="file-list-empty">No files attached</div>';
            return;
        }
        
        container.innerHTML = state.attachments.map(file => {
            const icon = Utils.getFileIcon(file.type, file.name);
            return `
            <div class="file-item" data-id="${file.id}">
                <span class="file-item__icon" style="background: ${icon.color}">${icon.label}</span>
                <div class="file-item__info">
                    <div class="file-item__name" title="${file.name}">${file.name}</div>
                    <div class="file-item__meta">${Utils.formatFileSize(file.size)} • ${file.addedAt}</div>
                </div>
                <div class="file-item__actions">
                    <button class="file-item__btn" data-action="preview" data-id="${file.id}">Preview</button>
                    <button class="file-item__btn" data-action="download" data-id="${file.id}">Download</button>
                    <button class="file-item__btn file-item__btn--delete" data-action="delete" data-id="${file.id}">Remove</button>
                </div>
            </div>
        `}).join('');
        
        // Also update the viz attachment dropdown
        updateVizAttachmentDropdown();
    }
    
    function updateVizAttachmentDropdown() {
        const select = Utils.$('ai-viz-attachment');
        if (!select) return;
        
        // Show all potentially data-containing files
        const dataFiles = (state.attachments || []).filter(a => {
            const name = a.name.toLowerCase();
            const type = a.type.toLowerCase();
            return name.endsWith('.csv') || 
                   name.endsWith('.tsv') ||
                   name.endsWith('.xlsx') ||
                   name.endsWith('.xls') ||
                   name.endsWith('.txt') ||
                   type.includes('csv') ||
                   type.includes('spreadsheet') ||
                   type.includes('excel') ||
                   type === 'text/plain' ||
                   type === 'text/tab-separated-values';
        });
        
        select.innerHTML = '<option value="">None - describe data manually</option>' +
            dataFiles.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
    }
    
    async function extractVisualizationData() {
        const promptEl = Utils.$('ai-prompt-visualization');
        const prompt = promptEl.value.trim();
        const attachmentId = Utils.$('ai-viz-attachment').value;
        
        if (!attachmentId && !prompt) {
            showToast('Select an attachment or describe data to generate');
            return;
        }
        
        if (!attachmentId && prompt.length < 20) {
            showToast('Select an attachment, or provide a detailed description');
            return;
        }
        
        const btn = document.querySelector('[data-generate="visualization"]');
        btn.classList.add('loading');
        btn.disabled = true;
        
        // Get attachment content if selected
        let fileContent = '';
        let fileName = '';
        if (attachmentId) {
            const attachment = state.attachments.find(a => a.id === attachmentId);
            if (attachment) {
                fileName = attachment.name;
                const base64Data = attachment.data.split(',')[1];
                
                try {
                    // Check if it's an Excel file
                    const isExcel = attachment.name.endsWith('.xlsx') || 
                                    attachment.name.endsWith('.xls') ||
                                    attachment.type.includes('spreadsheet') ||
                                    attachment.type.includes('excel');
                    
                    if (isExcel && typeof XLSX !== 'undefined') {
                        // Parse Excel with SheetJS
                        const binaryStr = atob(base64Data);
                        const workbook = XLSX.read(binaryStr, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        fileContent = XLSX.utils.sheet_to_csv(firstSheet);
                    } else {
                        // Treat as text (CSV/TSV)
                        fileContent = atob(base64Data);
                    }
                } catch (e) {
                    console.error('File parse error:', e);
                    showToast('Could not read file');
                    btn.classList.remove('loading');
                    btn.disabled = false;
                    return;
                }
            }
        }
        
        // Build the prompt
        const systemPrompt = `You are a data extraction assistant. Extract data from the provided content and return it in a specific JSON format.

The user wants to populate a chart with time-series data. Extract relevant data and return ONLY valid JSON in this exact format (no other text):

{
  "labels": ["2024", "2025", ...],
  "series": [
    {"name": "Series Name", "color": "#4a6fa5", "data": [100, 200, ...]},
    {"name": "Another Series", "color": "#6b8f71", "data": [50, 75, ...]}
  ],
  "labelFormat": "years"
}

CRITICAL RULES FOR LABELS:
- MIRROR the date format used in the source file exactly
- If the file shows years (2024, 2025), use: ["2024", "2025"] and labelFormat: "years"
- If the file shows months (Jan 2024, Feb 2024), use: ["2024-01", "2024-02"] and labelFormat: "months"  
- If the file shows quarters (Q1 2024, Q2 2024), use: ["Q1 2024", "Q2 2024"] and labelFormat: "quarters"
- If the file shows fiscal years (FY24, FY25), use: ["FY24", "FY25"] and labelFormat: "fiscal"
- Extract the ACTUAL dates/periods from the source - do NOT make up or infer dates
- The number of labels MUST match the number of data points in each series

DATA RULES:
- Data values must be numbers only (no commas, currency symbols, or text)
- If a cell is empty or N/A, use 0
- Pick sensible colors: blue (#4a6fa5), green (#6b8f71), gold (#c9a227), red (#b54848), purple (#7c5295)

If you can't extract data, return: {"error": "description of problem"}

${fileContent ? `FILE CONTENT (${fileName}):\n${fileContent}\n\n` : ''}
USER REQUEST: ${prompt || 'Extract all data series from this file'}`;

        try {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    messages: [{ role: 'user', content: systemPrompt }]
                })
            });
            
            const result = await response.json();
            const content = result.content[0].text.trim();
            
            // Try to parse JSON from response
            let extracted;
            try {
                // Handle case where Claude wraps in markdown code block
                const jsonMatch = content.match(/```(?:json)?\s*([\s\S]*?)\s*```/) || [null, content];
                extracted = JSON.parse(jsonMatch[1]);
            } catch (e) {
                console.error('Parse error:', e, 'Content:', content);
                showPreviewError('Could not parse response. Raw: ' + content.substring(0, 150) + '...');
                return;
            }
            
            if (extracted.error) {
                showPreviewError(extracted.error);
                return;
            }
            
            if (!extracted.labels || !extracted.series) {
                showPreviewError('Response missing required fields');
                return;
            }
            
            // Store for applying later
            pendingExtraction = extracted;
            showPreviewSuccess(extracted);
            
        } catch (e) {
            console.error(e);
            showPreviewError('API request failed');
        } finally {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }
    
    function showPreviewError(message) {
        const preview = Utils.$('ai-viz-preview');
        const content = Utils.$('ai-viz-preview-content');
        preview.style.display = 'block';
        content.innerHTML = `<div class="ai-panel__preview-error">⚠ ${message}</div>`;
        pendingExtraction = null;
    }
    
    function showPreviewSuccess(data) {
        const preview = Utils.$('ai-viz-preview');
        const content = Utils.$('ai-viz-preview-content');
        preview.style.display = 'block';
        
        const granularity = DateService.detectGranularity(data.labels);
        const firstLabel = DateService.format(data.labels[0]);
        const lastLabel = DateService.format(data.labels[data.labels.length - 1]);
        
        content.innerHTML = `
            <div style="margin-bottom: var(--space-2); color: var(--gray-500);">
                ${data.labels.length} periods (${granularity}): ${firstLabel} → ${lastLabel}
            </div>
            ${data.series.map(s => `
                <div class="ai-panel__preview-series">
                    <div class="ai-panel__preview-series-name" style="color: ${s.color}">
                        ${s.name}
                    </div>
                    <div class="ai-panel__preview-series-data">
                        ${s.data.slice(0, 6).map(v => Utils.formatNumber(v)).join(', ')}${s.data.length > 6 ? '...' : ''}
                    </div>
                </div>
            `).join('')}
        `;
    }
    
    function applyExtraction() {
        if (!pendingExtraction) return;
        
        // Normalize labels through DateService
        state.chart.labels = DateService.normalizeLabels(pendingExtraction.labels);
        state.chart.series = pendingExtraction.series;
        state.chart.cellComments = {}; // Clear old comments
        
        renderChart();
        renderTable(Utils.$('viz-table-display'), { mode: 'view' });
        renderTable(Utils.$('data-table-container'), { mode: 'edit' });
        renderVizNotes();
        renderAllComments();
        renderPaletteSwatches();
        saveState();
        
        // Hide preview
        Utils.$('ai-viz-preview').style.display = 'none';
        pendingExtraction = null;
        
        showToast('Data applied to chart');
    }
    
    // ============================================================
    // EVENT HANDLERS
    // ============================================================
    function setupEventListeners() {
        // Data table events
        Utils.$('data-table-container').addEventListener('input', (e) => {
            const t = e.target;
            if (t.matches('input[data-series][data-col]')) {
                state.chart.series[+t.dataset.series].data[+t.dataset.col] = Utils.parseNumber(t.value);
                renderChart();
                renderTable(Utils.$('viz-table-display'), { mode: 'view' });
                saveState();
            }
            if (t.matches('.series-name-input')) {
                state.chart.series[+t.dataset.series].name = t.value;
                renderChart();
                renderTable(Utils.$('viz-table-display'), { mode: 'view' });
                saveState();
            }
            if (t.matches('.color-picker')) {
                state.chart.series[+t.dataset.series].color = t.value;
                renderChart();
                renderTable(Utils.$('viz-table-display'), { mode: 'view' });
                saveState();
            }
        });
        
        Utils.$('data-table-container').addEventListener('change', (e) => {
            if (e.target.matches('.col-date-select')) {
                state.chart.labels[+e.target.dataset.col] = e.target.value;
                renderChart();
                renderTable(Utils.$('viz-table-display'), { mode: 'view' });
                renderVizNotes();
                saveState();
            }
        });
        
        Utils.$('data-table-container').addEventListener('click', (e) => {
            const cell = e.target.closest('td.value-cell');
            if (cell?.dataset.cell) {
                const [si, ci] = cell.dataset.cell.split('-').map(Number);
                openModal('comment', { seriesIndex: si, colIndex: ci });
            }
        });
        
        // Comments table clicks
        Utils.$('comments-table').addEventListener('click', (e) => {
            const row = e.target.closest('.comment-row');
            if (!row) return;
            if (row.dataset.key) {
                const [si, ci] = row.dataset.key.split('-').map(Number);
                openModal('comment', { seriesIndex: si, colIndex: ci });
            } else if (row.dataset.type === 'general') {
                openModal('general-comment', { index: +row.dataset.index });
            }
        });
        
        Utils.$('description-comments-table').addEventListener('click', (e) => {
            const row = e.target.closest('.comment-row');
            if (row?.dataset.type === 'description') {
                openModal('description-comment', { index: +row.dataset.index });
            }
        });
        
        // Field inputs
        Utils.$('field-section-header').addEventListener('input', (e) => {
            state.sectionHeader = e.target.value;
            renderSlide();
            saveState();
        });
        
        Utils.$('field-title').addEventListener('input', (e) => {
            state.title = e.target.value;
            renderSlide();
            saveState();
        });
        
        Utils.$('field-description').addEventListener('input', (e) => {
            state.description = e.target.value;
            autoResizeTextarea(e.target);
            renderSlide();
            saveState();
        });
        
        // Editable markdown
        const descContainer = Utils.$('field-description-container');
        const descDisplay = Utils.$('field-description-display');
        const descEditor = Utils.$('field-description');
        
        descDisplay.addEventListener('click', () => {
            descContainer.classList.add('editing');
            requestAnimationFrame(() => {
                autoResizeTextarea(descEditor);
                descEditor.focus();
            });
        });
        
        descEditor.addEventListener('blur', () => {
            descContainer.classList.remove('editing');
            descDisplay.innerHTML = Utils.parseMarkdown(state.description);
        });
        
        // Add comment buttons
        Utils.$('add-comment-btn').addEventListener('click', () => openModal('general-comment', { index: -1 }));
        Utils.$('add-description-comment-btn').addEventListener('click', () => openModal('description-comment', { index: -1 }));
        
        // Chart type
        Utils.$('chart-type-select').addEventListener('change', (e) => {
            state.chart.type = e.target.value;
            renderChart();
            saveState();
        });
        
        // View tabs
        Utils.$$('.tab[data-view]').forEach(tab => {
            tab.addEventListener('click', () => {
                const view = tab.dataset.view;
                const slide = Utils.$('slide');
                
                Utils.$$('.viz-view').forEach(v => v.classList.remove('active'));
                Utils.$$('.tab[data-view]').forEach(t => t.classList.remove('active'));
                Utils.$('viz-view-' + view).classList.add('active');
                tab.classList.add('active');
                
                slide.classList.remove('view-output', 'view-table', 'view-notes');
                slide.classList.add('view-' + view);
            });
        });
        
        // Export dropdown
        Utils.$('export-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            Utils.$('export-dropdown').classList.toggle('open');
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) Utils.$('export-dropdown').classList.remove('open');
        });
        
        Utils.$('export-dropdown').addEventListener('click', (e) => {
            const btn = e.target.closest('.dropdown__item');
            if (!btn) return;
            Utils.$('export-dropdown').classList.remove('open');
            showToast(`${btn.dataset.export || btn.dataset.copy} coming soon`);
        });
        
        // Modal events
        ['comment', 'general-comment', 'description-comment'].forEach(type => {
            Utils.$(`${type}-modal-overlay`).addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal(type);
            });
            Utils.$(`${type}-modal-close`).addEventListener('click', () => closeModal(type));
            Utils.$(`${type}-modal-save`).addEventListener('click', () => saveModal(type));
            Utils.$(`${type}-modal-delete`).addEventListener('click', () => deleteModal(type));
        });
        
        // Code view tabs
        Utils.$$('[data-code-view]').forEach(tab => {
            tab.addEventListener('click', () => {
                Utils.$$('.code-view').forEach(v => v.classList.remove('active'));
                Utils.$$('[data-code-view]').forEach(t => t.classList.remove('active'));
                Utils.$('code-view-' + tab.dataset.codeView).classList.add('active');
                tab.classList.add('active');
                
                if (tab.dataset.codeView === 'json') {
                    Utils.$('json-code').textContent = JSON.stringify(state, null, 2);
                }
            });
        });
        
        // AI settings
        Utils.$('ai-context').addEventListener('input', (e) => {
            state.aiSettings.context = e.target.value;
            saveState();
        });
        
        Utils.$('ai-tone').addEventListener('change', (e) => {
            state.aiSettings.tone = e.target.value;
            saveState();
        });
        
        Utils.$('ai-growth-rules').addEventListener('input', (e) => {
            state.aiSettings.growthRules = e.target.value;
            saveState();
        });
        
        // AI triggers
        Utils.$$('[data-ai]').forEach(btn => {
            btn.addEventListener('click', () => {
                const field = btn.dataset.ai;
                const panel = Utils.$('ai-' + field);
                const promptEl = Utils.$('ai-prompt-' + field);
                
                panel.classList.toggle('open');
                if (panel.classList.contains('open')) {
                    // Refresh dropdown when opening visualization panel
                    if (field === 'visualization') {
                        updateVizAttachmentDropdown();
                    }
                    if (state.lastPrompts?.[field]) {
                        promptEl.value = state.lastPrompts[field];
                    }
                }
            });
        });
        
        Utils.$$('.ai-panel__input').forEach(textarea => {
            textarea.addEventListener('input', (e) => {
                const field = e.target.id.replace('ai-prompt-', '');
                if (!state.lastPrompts) state.lastPrompts = {};
                state.lastPrompts[field] = e.target.value;
                saveState();
            });
        });
        
        Utils.$$('[data-generate]').forEach(btn => {
            btn.addEventListener('click', () => {
                const field = btn.dataset.generate;
                if (field === 'visualization') {
                    extractVisualizationData();
                } else {
                    generateAI(field);
                }
            });
        });
        
        Utils.$$('.ai-size-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const field = e.target.dataset.field;
                if (field && state.lastPrompts?.[field]) {
                    generateAI(field, e.target.value);
                }
            });
        });
        
        Utils.$('save-prompt-description').addEventListener('click', () => savePrompt('description'));
        
        // File upload handlers
        const fileInput = Utils.$('file-input');
        const dropzone = Utils.$('file-dropzone');
        
        Utils.$('file-browse-btn').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileInput.click();
        });
        
        dropzone.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFiles(e.target.files);
                e.target.value = ''; // Reset for re-upload of same file
            }
        });
        
        // Drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        
        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFiles(e.dataTransfer.files);
            }
        });
        
        // File list actions
        Utils.$('file-list').addEventListener('click', (e) => {
            const btn = e.target.closest('[data-action]');
            const item = e.target.closest('.file-item');
            
            if (btn) {
                e.stopPropagation();
                const id = btn.dataset.id;
                if (btn.dataset.action === 'preview') previewAttachment(id);
                if (btn.dataset.action === 'download') downloadAttachment(id);
                if (btn.dataset.action === 'delete') removeAttachment(id);
            } else if (item) {
                // Click on row (not button) opens preview
                previewAttachment(item.dataset.id);
            }
        });
        
        // File preview modal
        Utils.$('file-preview-modal-overlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeFilePreview();
        });
        Utils.$('file-preview-close').addEventListener('click', closeFilePreview);
        Utils.$('file-preview-download').addEventListener('click', () => {
            if (currentPreviewId) downloadAttachment(currentPreviewId);
        });
        
        // Apply extraction button
        Utils.$('ai-viz-apply').addEventListener('click', applyExtraction);
        
        Utils.$('saved-prompts-description').addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.ai-panel__saved-item-delete');
            const item = e.target.closest('.ai-panel__saved-item');
            
            if (deleteBtn) {
                const idx = +deleteBtn.dataset.delete;
                state.savedPrompts.description.splice(idx, 1);
                saveState();
                renderSavedPrompts('description');
            } else if (item) {
                const prompt = state.savedPrompts?.description?.[+item.dataset.index];
                if (prompt) {
                    Utils.$('ai-prompt-description').value = prompt;
                    state.lastPrompts.description = prompt;
                    saveState();
                }
            }
        });
        
        // Resize handles
        setupResizeHandles();
        
        // Watch for layout changes
        new ResizeObserver(() => requestAnimationFrame(checkDescriptionOverflow))
            .observe(document.querySelector('.slide__description-content'));
    }
    
    function setupResizeHandles() {
        const slide = Utils.$('slide');
        let isResizing = false, currentHandle = null;
        
        slide.style.setProperty('--col-split', '35%');
        slide.style.setProperty('--col-split-right', '65%');
        
        document.querySelectorAll('.resize-handle').forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                currentHandle = e.target.dataset.resize;
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });
        });
        
        function resize(e) {
            if (!isResizing) return;
            const rect = slide.getBoundingClientRect();
            
            if (currentHandle === 'col') {
                const pct = Math.max(20, Math.min(80, ((e.clientX - rect.left) / rect.width) * 100));
                slide.style.setProperty('--col-split', pct + '%');
                slide.style.setProperty('--col-split-right', (100 - pct) + '%');
            }
        }
        
        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }
    }
    
    // ============================================================
    // INIT
    // ============================================================
    loadState();
    renderAll();
    setupEventListeners();
    Utils.$('chart-type-select').value = state.chart.type;
    </script>
</body>
</html>
